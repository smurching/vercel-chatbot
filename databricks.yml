bundle:
  name: databricks-chatbot

variables:
  serving_endpoint_name:
    description: "Name of the model serving endpoint to be used by the app"
    default: "agents_sidmurching_catalog-default-test_chat_app_agent" # TODO: specify a default value here to avoid needing to specify it on each deployment
  database_instance_name:
    description: "Base name of the Lakebase database instance"
    default: "chatbot-lakebase"
  resource_name_suffix:
    description: "Suffix for resource names (app/lakebase instance names etc). Helpful for avoiding name collisions if multiple users deploy this app to the same workspace"

resources:
  database_instances:
    chatbot_lakebase:
      name: ${var.database_instance_name}-${var.resource_name_suffix}
      capacity: CU_1

  database_catalogs:
    chatbot_catalog:
      database_instance_name: ${resources.database_instances.chatbot_lakebase.name}
      name: chatbot_catalog_${var.resource_name_suffix}
      database_name: databricks_postgres
      create_database_if_not_exists: true

  apps:
    databricks_chatbot:
      name: ${var.resource_name_suffix}
      description: "Chatbot UI for Agent Bricks and custom code agents"
      source_code_path: .
      resources:
        - name: serving-endpoint
          description: "Databricks serving endpoint name for the AI agent"
          serving_endpoint:
            name: ${var.serving_endpoint_name}
            permission: CAN_QUERY
        - name: database
          description: "Databricks serving endpoint name for the AI agent"
          database:
            database_name: databricks_postgres
            instance_name: ${resources.database_instances.chatbot_lakebase.name}
            permission: CAN_CONNECT_AND_CREATE
      user_api_scopes: ["serving.serving-endpoints"]

targets:
  dev:
    mode: development
    default: true
    variables:
      resource_name_suffix: dev-${workspace.current_user.domain_friendly_name}

  obo:
    mode: development
    variables:
      resource_name_suffix: dev-${workspace.current_user.domain_friendly_name}-obo

  staging:
    mode: production
    variables:
      resource_name_suffix: "staging"

  prod:
    mode: production
    variables:
      resource_name_suffix: "prod"
